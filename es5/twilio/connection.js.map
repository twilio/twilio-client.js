{"version":3,"file":"connection.js","sourceRoot":"","sources":["../../lib/twilio/connection.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @module Voice\n * @publicapi\n * @internal\n */\nimport { EventEmitter } from 'events';\nimport Device from './device';\nimport DialtonePlayer from './dialtonePlayer';\nimport { Region } from './regions';\nimport RTCMonitor from './rtc/monitor';\nimport RTCSample from './rtc/sample';\nimport RTCWarning from './rtc/warning';\nimport Log, { LogLevel } from './tslog';\nimport { average, Exception } from './util';\n\nconst C = require('./constants');\nconst PeerConnection = require('./rtc').PeerConnection;\n\n// Placeholders until we convert the respective files to TypeScript.\n/**\n * @private\n */\nexport type IAudioHelper = any;\n/**\n * @private\n */\nexport type IPStream = any;\n/**\n * @private\n */\nexport type IPeerConnection = any;\n/**\n * @private\n */\nexport type IPublisher = any;\n/**\n * @private\n */\nexport type ISound = any;\n\nconst DTMF_INTER_TONE_GAP: number = 70;\nconst DTMF_PAUSE_DURATION: number = 500;\nconst DTMF_TONE_DURATION: number = 160;\n\nconst ICE_RESTART_INTERVAL = 3000;\nconst METRICS_BATCH_SIZE: number = 10;\nconst METRICS_DELAY: number = 5000;\n\nconst WARNING_NAMES: Record<string, string> = {\n  audioInputLevel: 'audio-input-level',\n  audioOutputLevel: 'audio-output-level',\n  bytesReceived: 'bytes-received',\n  bytesSent: 'bytes-sent',\n  jitter: 'jitter',\n  mos: 'mos',\n  packetsLostFraction: 'packet-loss',\n  rtt: 'rtt',\n};\n\nconst WARNING_PREFIXES: Record<string, string> = {\n  max: 'high-',\n  maxDuration: 'constant-',\n  min: 'low-',\n};\n\nlet hasBeenWarnedHandlers = false;\n\n/**\n * A {@link Connection} represents a media and signaling connection to a TwiML application.\n * @publicapi\n */\nclass Connection extends EventEmitter {\n  /**\n   * String representation of the {@link Connection} class.\n   * @private\n   */\n  static toString = () => '[Twilio.Connection class]';\n\n  /**\n   * The custom parameters sent to (outgoing) or received by (incoming) the TwiML app.\n   */\n  readonly customParameters: Map<string, string>;\n\n  /**\n   * Whether this {@link Connection} is incoming or outgoing.\n   */\n  get direction(): Connection.CallDirection {\n    return this._direction;\n  }\n\n  /**\n   * Audio codec used for this {@link Connection}. Expecting {@link Connection.Codec} but\n   * will copy whatever we get from RTC stats.\n   */\n  get codec(): string {\n    return this._codec;\n  }\n\n  /**\n   * The MediaStream (Twilio PeerConnection) this {@link Connection} is using for\n   * media signaling.\n   * @private\n   */\n  mediaStream: IPeerConnection;\n\n  /**\n   * The temporary CallSid for this call, if it's outbound.\n   */\n  readonly outboundConnectionId?: string;\n\n  /**\n   * Call parameters received from Twilio for an incoming call.\n   */\n  parameters: Record<string, string> = { };\n\n  /**\n   * Audio codec used for this {@link Connection}. Expecting {@link Connection.Codec} but\n   * will copy whatever we get from RTC stats.\n   */\n  private _codec: string;\n\n  /**\n   * Whether this {@link Connection} is incoming or outgoing.\n   */\n  private readonly _direction: Connection.CallDirection;\n\n  /**\n   * Interval id for ICE restart loop\n   */\n  private _iceRestartIntervalId: number;\n\n  /**\n   * The number of times input volume has been the same consecutively.\n   */\n  private _inputVolumeStreak: number = 0;\n\n  /**\n   * Keeps track of internal input volumes in the last second\n   */\n  private _internalInputVolumes: number[] = [];\n\n  /**\n   * Keeps track of internal output volumes in the last second\n   */\n  private _internalOutputVolumes: number[] = [];\n\n  /**\n   * Whether the call has been answered.\n   */\n  private _isAnswered: boolean = false;\n\n  /**\n   * Whether or not the browser uses unified-plan SDP by default.\n   */\n  private readonly _isUnifiedPlanDefault: boolean;\n\n  /**\n   * The most recent public input volume value. 0 -> 1 representing -100 to -30 dB.\n   */\n  private _latestInputVolume: number = 0;\n\n  /**\n   * The most recent public output volume value. 0 -> 1 representing -100 to -30 dB.\n   */\n  private _latestOutputVolume: number = 0;\n\n  /**\n   * An instance of Log to use.\n   */\n  private readonly _log: Log = new Log(LogLevel.Off);\n\n  /**\n   * A batch of metrics samples to send to Insights. Gets cleared after\n   * each send and appended to on each new sample.\n   */\n  private readonly _metricsSamples: Connection.CallMetrics[] = [];\n\n  /**\n   * An instance of RTCMonitor.\n   */\n  private readonly _monitor: RTCMonitor;\n\n  /**\n   * The number of times output volume has been the same consecutively.\n   */\n  private _outputVolumeStreak: number = 0;\n\n  /**\n   * An instance of EventPublisher.\n   */\n  private readonly _publisher: IPublisher;\n\n  /**\n   * A Map of Sounds to play.\n   */\n  private readonly _soundcache: Map<Device.SoundName, ISound> = new Map();\n\n  /**\n   * State of the {@link Connection}.\n   */\n  private _status: Connection.State = Connection.State.Pending;\n\n  /**\n   * TwiML params for the call. May be set for either outgoing or incoming calls.\n   */\n  private readonly message: Record<string, string>;\n\n  /**\n   * Options passed to this {@link Connection}.\n   */\n  private options: Connection.Options = {\n    debug: false,\n    enableRingingState: false,\n    mediaStreamFactory: PeerConnection,\n    offerSdp: null,\n    shouldPlayDisconnect: () => true,\n  };\n\n  /**\n   * The PStream instance to use for Twilio call signaling.\n   */\n  private readonly pstream: IPStream;\n\n  /**\n   * Whether the {@link Connection} should send a hangup on disconnect.\n   */\n  private sendHangup: boolean = true;\n\n  /**\n   * @constructor\n   * @private\n   * @param config - Mandatory configuration options\n   * @param [options] - Optional settings\n   */\n  constructor(config: Connection.Config, options?: Connection.Options) {\n    super();\n\n    this._isUnifiedPlanDefault = config.isUnifiedPlanDefault;\n    this._soundcache = config.soundcache;\n    this.message = options && options.twimlParams || { };\n    this.customParameters = new Map(\n      Object.entries(this.message).map(([key, val]: [string, any]): [string, string] => [key, String(val)]));\n\n    Object.assign(this.options, options);\n\n    if (this.options.callParameters) {\n      this.parameters = this.options.callParameters;\n    }\n\n    this._direction = this.parameters.CallSid ? Connection.CallDirection.Incoming : Connection.CallDirection.Outgoing;\n\n    this._log.setLogLevel(this.options.debug ? LogLevel.Debug\n      : this.options.warnings ? LogLevel.Warn\n      : LogLevel.Off);\n\n    const publisher = this._publisher = config.publisher;\n\n    if (this._direction === Connection.CallDirection.Incoming) {\n      publisher.info('connection', 'incoming', null, this);\n    }\n\n    const monitor = this._monitor = new (this.options.RTCMonitor || RTCMonitor)();\n    monitor.on('sample', this._onRTCSample);\n\n    // First 20 seconds or so are choppy, so let's not bother with these warnings.\n    monitor.disableWarnings();\n    setTimeout(() => monitor.enableWarnings(), METRICS_DELAY);\n\n    monitor.on('warning', (data: RTCWarning, wasCleared?: boolean) => {\n      if (data.name === 'bytesSent' || data.name === 'bytesReceived') {\n        this._log.warn('ICE Connection disconnected.');\n        clearInterval(this._iceRestartIntervalId);\n        this._iceRestartIntervalId = setInterval(\n          this.mediaStream.iceRestart.bind(this.mediaStream), ICE_RESTART_INTERVAL);\n      }\n      this._reemitWarning(data, wasCleared);\n    });\n    monitor.on('warning-cleared', (data: RTCWarning) => {\n      if (data.name === 'bytesSent' || data.name === 'bytesReceived') {\n        this._log.info('ICE Connection reestablished.');\n        clearInterval(this._iceRestartIntervalId);\n      }\n      this._reemitWarningCleared(data);\n    });\n\n    this.mediaStream = new (this.options.MediaStream || this.options.mediaStreamFactory)\n      (config.audioHelper, config.pstream, config.getUserMedia, {\n        codecPreferences: this.options.codecPreferences,\n        debug: this.options.debug,\n        dscp: this.options.dscp,\n        isUnifiedPlan: this._isUnifiedPlanDefault,\n        warnings: this.options.warnings,\n      });\n\n    this.on('volume', (inputVolume: number, outputVolume: number): void => {\n      this._inputVolumeStreak = this._checkVolume(\n        inputVolume, this._inputVolumeStreak, this._latestInputVolume, 'input');\n      this._outputVolumeStreak = this._checkVolume(\n        outputVolume, this._outputVolumeStreak, this._latestOutputVolume, 'output');\n      this._latestInputVolume = inputVolume;\n      this._latestOutputVolume = outputVolume;\n    });\n\n    this.mediaStream.onvolume = (inputVolume: number, outputVolume: number,\n                                 internalInputVolume: number, internalOutputVolume: number) => {\n      // (rrowland) These values mock the 0 -> 32767 format used by legacy getStats. We should look into\n      // migrating to a newer standard, either 0.0 -> linear or -127 to 0 in dB, matching the range\n      // chosen below.\n\n      this._internalInputVolumes.push((internalInputVolume / 255) * 32767);\n      this._internalOutputVolumes.push((internalOutputVolume / 255) * 32767);\n\n      // (rrowland) 0.0 -> 1.0 linear\n      this.emit('volume', inputVolume, outputVolume);\n    };\n\n    this.mediaStream.oniceconnectionstatechange = (state: string): void => {\n      const level = state === 'failed' ? 'error' : 'debug';\n      this._publisher.post(level, 'ice-connection-state', state, null, this);\n    };\n\n    this.mediaStream.onicegatheringstatechange = (state: string): void => {\n      this._publisher.debug('ice-gathering-state', state, null, this);\n    };\n\n    this.mediaStream.onsignalingstatechange = (state: string): void => {\n      this._publisher.debug('signaling-state', state, null, this);\n    };\n\n    this.mediaStream.ondisconnect = (msg: string): void => {\n      this._log.info(msg);\n      this._publisher.warn('network-quality-warning-raised', 'ice-connectivity-lost', {\n        message: msg,\n      }, this);\n      this.emit('warning', 'ice-connectivity-lost');\n    };\n\n    this.mediaStream.onreconnect = (msg: string): void => {\n      this._log.info(msg);\n      this._publisher.info('network-quality-warning-cleared', 'ice-connectivity-lost', {\n        message: msg,\n      }, this);\n      this.emit('warning-cleared', 'ice-connectivity-lost');\n    };\n\n    this.mediaStream.onerror = (e: any): void => {\n      if (e.disconnect === true) {\n        this._disconnect(e.info && e.info.message);\n      }\n\n      const error: Connection.Error = {\n        code: e.info.code,\n        connection: this,\n        info: e.info,\n        message: e.info.message || 'Error with mediastream',\n      };\n\n      this._log.error('Received an error from MediaStream:', e);\n      this.emit('error', error);\n    };\n\n    this.mediaStream.onopen = () => {\n      // NOTE(mroberts): While this may have been happening in previous\n      // versions of Chrome, since Chrome 45 we have seen the\n      // PeerConnection's onsignalingstatechange handler invoked multiple\n      // times in the same signalingState 'stable'. When this happens, we\n      // invoke this onopen function. If we invoke it twice without checking\n      // for _status 'open', we'd accidentally close the PeerConnection.\n      //\n      // See <https://code.google.com/p/webrtc/issues/detail?id=4996>.\n      if (this._status === Connection.State.Open) {\n        return;\n      } else if (this._status === Connection.State.Ringing || this._status === Connection.State.Connecting) {\n        this.mute(false);\n        this._maybeTransitionToOpen();\n      } else {\n        // call was probably canceled sometime before this\n        this.mediaStream.close();\n      }\n    };\n\n    this.mediaStream.onclose = () => {\n      this._status = Connection.State.Closed;\n      if (this.options.shouldPlayDisconnect && this.options.shouldPlayDisconnect()) {\n        this._soundcache.get(Device.SoundName.Disconnect).play();\n      }\n\n      monitor.disable();\n      this._publishMetrics();\n\n      this.emit('disconnect', this);\n    };\n\n    // temporary call sid to be used for outgoing calls\n    this.outboundConnectionId = generateTempCallSid();\n\n    this.pstream = config.pstream;\n    this.pstream.on('cancel', this._onCancel);\n    this.pstream.on('ringing', this._onRinging);\n\n    this.on('error', error => {\n      this._publisher.error('connection', 'error', {\n        code: error.code, message: error.message,\n      }, this);\n\n      if (this.pstream && this.pstream.status === 'disconnected') {\n        this._cleanupEventListeners();\n      }\n    });\n\n    this.on('disconnect', () => {\n      this._cleanupEventListeners();\n    });\n  }\n\n  /**\n   * Get the real CallSid. Returns null if not present or is a temporary call sid.\n   * @deprecated\n   * @private\n   */\n  _getRealCallSid(): string | null {\n    this._log.warn('_getRealCallSid is deprecated and will be removed in 2.0.');\n    return /^TJ/.test(this.parameters.CallSid) ? null : this.parameters.CallSid;\n  }\n\n  /**\n   * Get the temporary CallSid.\n   * @deprecated\n   * @private\n   */\n  _getTempCallSid(): string | undefined {\n    this._log.warn('_getTempCallSid is deprecated and will be removed in 2.0. \\\n                    Please use outboundConnectionId instead.');\n    return this.outboundConnectionId;\n  }\n\n  /**\n   * Set the audio input tracks from a given stream.\n   * @param stream\n   * @private\n   */\n  _setInputTracksFromStream(stream: MediaStream | null): Promise<void> {\n    return this.mediaStream.setInputTracksFromStream(stream);\n  }\n\n  /**\n   * Set the audio output sink IDs.\n   * @param sinkIds\n   * @private\n   */\n  _setSinkIds(sinkIds: string[]): Promise<void> {\n    return this.mediaStream._setSinkIds(sinkIds);\n  }\n\n  /**\n   * Accept the incoming {@link Connection}.\n   * @param [audioConstraints]\n   */\n  accept(audioConstraints?: MediaTrackConstraints | boolean): void;\n  /**\n   * @deprecated - Set a handler for the {@link acceptEvent}\n   * @param handler\n   */\n  accept(handler: (connection: this) => void): void;\n  accept(handlerOrConstraints?: ((connection: this) => void) | MediaTrackConstraints | boolean): void {\n    if (typeof handlerOrConstraints === 'function') {\n      this._addHandler('accept', handlerOrConstraints);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    const audioConstraints = handlerOrConstraints || this.options.audioConstraints;\n    this._status = Connection.State.Connecting;\n\n    const connect = () => {\n      if (this._status !== Connection.State.Connecting) {\n        // call must have been canceled\n        this._cleanupEventListeners();\n        this.mediaStream.close();\n        return;\n      }\n\n      const onLocalAnswer = (pc: RTCPeerConnection) => {\n        this._publisher.info('connection', 'accepted-by-local', null, this);\n        this._monitor.enable(pc);\n      };\n\n      const onRemoteAnswer = (pc: RTCPeerConnection) => {\n        this._publisher.info('connection', 'accepted-by-remote', null, this);\n        this._monitor.enable(pc);\n      };\n\n      const sinkIds = typeof this.options.getSinkIds === 'function' && this.options.getSinkIds();\n      if (Array.isArray(sinkIds)) {\n        this.mediaStream._setSinkIds(sinkIds).catch(() => {\n          // (rrowland) We don't want this to throw to console since the customer\n          // can't control this. This will most commonly be rejected on browsers\n          // that don't support setting sink IDs.\n        });\n      }\n\n      this.pstream.addListener('hangup', this._onHangup);\n\n      if (this._direction === Connection.CallDirection.Incoming) {\n        this._isAnswered = true;\n        this.mediaStream.answerIncomingCall(this.parameters.CallSid, this.options.offerSdp,\n          this.options.rtcConstraints, this.options.rtcConfiguration, onLocalAnswer);\n      } else {\n        const params = Array.from(this.customParameters.entries()).map(pair =>\n         `${encodeURIComponent(pair[0])}=${encodeURIComponent(pair[1])}`).join('&');\n        this.pstream.once('answer', this._onAnswer.bind(this));\n        this.mediaStream.makeOutgoingCall(this.pstream.token, params, this.outboundConnectionId,\n          this.options.rtcConstraints, this.options.rtcConfiguration, onRemoteAnswer);\n      }\n    };\n\n    if (this.options.beforeAccept) {\n      this.options.beforeAccept(this);\n    }\n\n    const inputStream = typeof this.options.getInputStream === 'function' && this.options.getInputStream();\n\n    const promise = inputStream\n      ? this.mediaStream.setInputTracksFromStream(inputStream)\n      : this.mediaStream.openWithConstraints(audioConstraints);\n\n    promise.then(() => {\n      this._publisher.info('get-user-media', 'succeeded', {\n        data: { audioConstraints },\n      }, this);\n\n      connect();\n    }, (error: Record<string, any>) => {\n      let message;\n      let code;\n\n      if (error.code && error.code === 31208\n        || error.name && error.name === 'PermissionDeniedError') {\n        code = 31208;\n        message = 'User denied access to microphone, or the web browser did not allow microphone '\n          + 'access at this address.';\n        this._publisher.error('get-user-media', 'denied', {\n          data: {\n            audioConstraints,\n            error,\n          },\n        }, this);\n      } else {\n        code = 31201;\n        message = `Error occurred while accessing microphone: ${error.name}${error.message\n          ? ` (${error.message})`\n          : ''}`;\n\n        this._publisher.error('get-user-media', 'failed', {\n          data: {\n            audioConstraints,\n            error,\n          },\n        }, this);\n      }\n\n      this._disconnect();\n      this.emit('error', { message, code });\n    });\n  }\n\n  /**\n   * @deprecated - Ignore the incoming {@link Connection}.\n   */\n  cancel(): void;\n  /**\n   * @deprecated - Set a handler for the {@link cancelEvent}\n   */\n  cancel(handler: () => void): void;\n  cancel(handler?: () => void): void {\n    this._log.warn('.cancel() is deprecated. Please use .ignore() instead.');\n\n    if (handler) {\n      this.ignore(handler);\n    } else {\n      this.ignore();\n    }\n  }\n\n  /**\n   * Disconnect from the {@link Connection}.\n   */\n  disconnect(): void;\n  /**\n   * @deprecated - Set a handler for the {@link disconnectEvent}\n   */\n  disconnect(handler: (connection: this) => void): void;\n  disconnect(handler?: (connection: this) => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('disconnect', handler);\n      return;\n    }\n    this._disconnect();\n  }\n\n  /**\n   * @deprecated - Set a handler for the {@link errorEvent}\n   */\n  error(handler: (error: Connection.Error) => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('error', handler);\n    }\n  }\n\n  /**\n   * Get the local MediaStream, if set.\n   */\n  getLocalStream(): MediaStream | undefined {\n    return this.mediaStream && this.mediaStream.stream;\n  }\n\n  /**\n   * Get the remote MediaStream, if set.\n   */\n  getRemoteStream(): MediaStream | undefined {\n    return this.mediaStream && this.mediaStream._remoteStream;\n  }\n\n  /**\n   * Ignore the incoming {@link Connection}.\n   */\n  ignore(): void;\n  /**\n   * @deprecated - Set a handler for the {@link cancelEvent}\n   */\n  ignore(handler: () => void): void;\n  ignore(handler?: () => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('cancel', handler);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    this._status = Connection.State.Closed;\n    this.emit('cancel');\n    this.mediaStream.ignore(this.parameters.CallSid);\n    this._publisher.info('connection', 'ignored-by-local', null, this);\n  }\n\n  /**\n   * Check if connection is muted\n   */\n  isMuted(): boolean {\n    return this.mediaStream.isMuted;\n  }\n\n  /**\n   * Mute incoming audio.\n   * @param shouldMute - Whether the incoming audio should be muted. Defaults to true.\n   */\n  mute(shouldMute?: boolean): void;\n  /**\n   * @deprecated - Set a handler for the {@link muteEvent}\n   */\n  mute(handler: (isMuted: boolean, connection: this) => void): void;\n  mute(shouldMute: boolean | ((isMuted: boolean, connection: this) => void) = true): void {\n    if (typeof shouldMute === 'function') {\n      this._addHandler('mute', shouldMute);\n      return;\n    }\n\n    const wasMuted = this.mediaStream.isMuted;\n    this.mediaStream.mute(shouldMute);\n\n    const isMuted = this.mediaStream.isMuted;\n    if (wasMuted !== isMuted) {\n      this._publisher.info('connection', isMuted ? 'muted' : 'unmuted', null, this);\n      this.emit('mute', isMuted, this);\n    }\n  }\n\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has given call quality feedback. Called without a score, this\n   *   will report that the customer declined to give feedback.\n   * @param score - The end-user's rating of the call; an\n   *   integer 1 through 5. Or undefined if the user declined to give\n   *   feedback.\n   * @param issue - The primary issue the end user\n   *   experienced on the call. Can be: ['one-way-audio', 'choppy-audio',\n   *   'dropped-call', 'audio-latency', 'noisy-call', 'echo']\n   */\n  postFeedback(score?: Connection.FeedbackScore, issue?: Connection.FeedbackIssue): Promise<void> {\n    if (typeof score === 'undefined' || score === null) {\n      return this._postFeedbackDeclined();\n    }\n\n    if (!Object.values(Connection.FeedbackScore).includes(score)) {\n      throw new Error(`Feedback score must be one of: ${Object.values(Connection.FeedbackScore)}`);\n    }\n\n    if (typeof issue !== 'undefined' && issue !== null && !Object.values(Connection.FeedbackIssue).includes(issue)) {\n      throw new Error(`Feedback issue must be one of: ${Object.values(Connection.FeedbackIssue)}`);\n    }\n\n    return this._publisher.info('feedback', 'received', {\n      issue_name: issue,\n      quality_score: score,\n    }, this, true);\n  }\n\n  /**\n   * Reject the incoming {@link Connection}.\n   */\n  reject(): void;\n  /**\n   * @deprecated - Set a handler for the {@link rejectEvent}\n   */\n  reject(handler: () => void): void;\n  reject(handler?: () => void): void {\n    if (typeof handler === 'function') {\n      this._addHandler('reject', handler);\n      return;\n    }\n\n    if (this._status !== Connection.State.Pending) {\n      return;\n    }\n\n    const payload = { callsid: this.parameters.CallSid };\n    this.pstream.publish('reject', payload);\n    this.emit('reject');\n    this.mediaStream.reject(this.parameters.CallSid);\n    this._publisher.info('connection', 'rejected-by-local', null, this);\n  }\n\n  /**\n   * Send a string of digits.\n   * @param digits\n   */\n  sendDigits(digits: string): void {\n    if (digits.match(/[^0-9*#w]/)) {\n      throw new Exception('Illegal character passed into sendDigits');\n    }\n\n    const sequence: string[] = [];\n    digits.split('').forEach((digit: string) => {\n      let dtmf = (digit !== 'w') ? `dtmf${digit}` : '';\n      if (dtmf === 'dtmf*') { dtmf = 'dtmfs'; }\n      if (dtmf === 'dtmf#') { dtmf = 'dtmfh'; }\n      sequence.push(dtmf);\n    });\n\n    // Binds soundCache to be used in recursion until all digits have been played.\n    (function playNextDigit(soundCache, dialtonePlayer) {\n      const digit: string | undefined = sequence.shift();\n\n      if (digit) {\n        if (dialtonePlayer) {\n          dialtonePlayer.play(digit);\n        } else {\n          soundCache.get(digit as Device.SoundName).play();\n        }\n      }\n\n      if (sequence.length) {\n        setTimeout(playNextDigit.bind(null, soundCache), 200);\n      }\n    })(this._soundcache, this.options.dialtonePlayer);\n\n    const dtmfSender = this.mediaStream.getOrCreateDTMFSender();\n\n    function insertDTMF(dtmfs: string[]) {\n      if (!dtmfs.length) { return; }\n      const dtmf: string | undefined = dtmfs.shift();\n\n      if (dtmf && dtmf.length) {\n        dtmfSender.insertDTMF(dtmf, DTMF_TONE_DURATION, DTMF_INTER_TONE_GAP);\n      }\n\n      setTimeout(insertDTMF.bind(null, dtmfs), DTMF_PAUSE_DURATION);\n    }\n\n    if (dtmfSender) {\n      if (!('canInsertDTMF' in dtmfSender) || dtmfSender.canInsertDTMF) {\n        this._log.info('Sending digits using RTCDTMFSender');\n        // NOTE(mroberts): We can't just map 'w' to ',' since\n        // RTCDTMFSender's pause duration is 2 s and Twilio's is more\n        // like 500 ms. Instead, we will fudge it with setTimeout.\n        insertDTMF(digits.split('w'));\n        return;\n      }\n\n      this._log.info('RTCDTMFSender cannot insert DTMF');\n    }\n\n    // send pstream message to send DTMF\n    this._log.info('Sending digits over PStream');\n\n    if (this.pstream !== null && this.pstream.status !== 'disconnected') {\n      this.pstream.publish('dtmf', {\n        callsid: this.parameters.CallSid,\n        dtmf: digits,\n      });\n    } else {\n      const error = {\n        code: 31000,\n        connection: this,\n        message: 'Could not send DTMF: Signaling channel is disconnected',\n      };\n      this.emit('error', error);\n    }\n  }\n\n  /**\n   * Get the current {@link Connection} status.\n   */\n  status(): Connection.State {\n    return this._status;\n  }\n\n  /**\n   * String representation of {@link Connection} instance.\n   * @private\n   */\n  toString = () => '[Twilio.Connection instance]';\n\n  /**\n   * @deprecated - Unmute the {@link Connection}.\n   */\n  unmute(): void {\n    this._log.warn('.unmute() is deprecated. Please use .mute(false) to unmute a call instead.');\n    this.mute(false);\n  }\n\n  /**\n   * @deprecated - Set a handler for the {@link volumeEvent}\n   * @param handler\n   */\n  volume(handler: (inputVolume: number, outputVolume: number) => void): void {\n    if (!window || (!(window as any).AudioContext && !(window as any).webkitAudioContext)) {\n      this._log.warn('This browser does not support Connection.volume');\n    }\n\n    this._addHandler('volume', handler);\n  }\n\n  /**\n   * Add a handler for an EventEmitter and emit a deprecation warning on first call.\n   * @param eventName - Name of the event\n   * @param handler - A handler to call when the event is emitted\n   */\n  private _addHandler(eventName: string, handler: (...args: any[]) => any): this {\n    if (!hasBeenWarnedHandlers) {\n      this._log.warn(`Connection callback handlers (accept, cancel, disconnect, error, ignore, mute, reject,\n        volume) have been deprecated and will be removed in the next breaking release. Instead, the EventEmitter \\\n        interface can be used to set event listeners. Example: connection.on('${eventName}', handler)`);\n      hasBeenWarnedHandlers = true;\n    }\n\n    this.addListener(eventName, handler);\n    return this;\n  }\n\n  /**\n   * Check the volume passed, emitting a warning if one way audio is detected or cleared.\n   * @param currentVolume - The current volume for this direction\n   * @param streakFieldName - The name of the field on the {@link Connection} object that tracks how many times the\n   *   current value has been repeated consecutively.\n   * @param lastValueFieldName - The name of the field on the {@link Connection} object that tracks the most recent\n   *   volume for this direction\n   * @param direction - The directionality of this audio track, either 'input' or 'output'\n   * @returns The current streak; how many times in a row the same value has been polled.\n   */\n  private _checkVolume(currentVolume: number, currentStreak: number,\n                       lastValue: number, direction: 'input'|'output'): number {\n    const wasWarningRaised: boolean = currentStreak >= 10;\n    let newStreak: number = 0;\n\n    if (lastValue === currentVolume) {\n      newStreak = currentStreak;\n    }\n\n    if (newStreak >= 10) {\n      this._emitWarning('audio-level-', `constant-audio-${direction}-level`, 10, newStreak, false);\n    } else if (wasWarningRaised) {\n      this._emitWarning('audio-level-', `constant-audio-${direction}-level`, 10, newStreak, true);\n    }\n\n    return newStreak;\n  }\n\n  /**\n   * Clean up event listeners.\n   */\n  private _cleanupEventListeners(): void {\n    const cleanup = () => {\n      if (!this.pstream) { return; }\n\n      this.pstream.removeListener('answer', this._onAnswer);\n      this.pstream.removeListener('cancel', this._onCancel);\n      this.pstream.removeListener('hangup', this._onHangup);\n      this.pstream.removeListener('ringing', this._onRinging);\n    };\n\n    // This is kind of a hack, but it lets us avoid rewriting more code.\n    // Basically, there's a sequencing problem with the way PeerConnection raises\n    // the\n    //\n    //   Cannot establish connection. Client is disconnected\n    //\n    // error in Connection#accept. It calls PeerConnection#onerror, which emits\n    // the error event on Connection. An error handler on Connection then calls\n    // cleanupEventListeners, but then control returns to Connection#accept. It's\n    // at this point that we add a listener for the answer event that never gets\n    // removed. setTimeout will allow us to rerun cleanup again, _after_\n    // Connection#accept returns.\n    cleanup();\n    setTimeout(cleanup, 0);\n  }\n\n  /**\n   * Create the payload wrapper for a batch of metrics to be sent to Insights.\n   */\n  private _createMetricPayload(): Partial<Record<string, string|boolean>> {\n    const payload: Partial<Record<string, string|boolean>> = {\n      call_sid: this.parameters.CallSid,\n      dscp: !!this.options.dscp,\n      sdk_version: C.RELEASE_VERSION,\n      selected_region: this.options.selectedRegion,\n    };\n\n    if (this.options.gateway) {\n      payload.gateway = this.options.gateway;\n    }\n\n    if (this.options.region) {\n      payload.region = this.options.region;\n    }\n\n    payload.direction = this._direction;\n    return payload;\n  }\n\n  /**\n   * Disconnect the {@link Connection}.\n   * @param message - A message explaining why the {@link Connection} is being disconnected.\n   * @param wasRemote - Whether the disconnect was triggered locally or remotely.\n   */\n  private _disconnect(message?: string | null, wasRemote?: boolean): void {\n    message = typeof message === 'string' ? message : null;\n\n    if (this._status !== Connection.State.Open\n        && this._status !== Connection.State.Connecting\n        && this._status !== Connection.State.Ringing) {\n      return;\n    }\n\n    this._log.info('Disconnecting...');\n    clearInterval(this._iceRestartIntervalId);\n\n    // send pstream hangup message\n    if (this.pstream !== null && this.pstream.status !== 'disconnected' && this.sendHangup) {\n      const callsid: string | undefined = this.parameters.CallSid || this.outboundConnectionId;\n      if (callsid) {\n        const payload: Partial<Record<string, string>> = { callsid };\n        if (message) {\n          payload.message = message;\n        }\n        this.pstream.publish('hangup', payload);\n      }\n    }\n\n    this._cleanupEventListeners();\n    this.mediaStream.close();\n\n    if (!wasRemote) {\n      this._publisher.info('connection', 'disconnected-by-local', null, this);\n    }\n  }\n\n  private _emitWarning = (groupPrefix: string, warningName: string, threshold: number,\n                          value: number|number[], wasCleared?: boolean): void => {\n    const groupSuffix = wasCleared ? '-cleared' : '-raised';\n    const groupName = `${groupPrefix}warning${groupSuffix}`;\n\n    // Ignore constant input if the Connection is muted (Expected)\n    if (warningName === 'constant-audio-input-level' && this.isMuted()) {\n      return;\n    }\n\n    let level = wasCleared ? 'info' : 'warning';\n\n    // Avoid throwing false positives as warnings until we refactor volume metrics\n    if (warningName === 'constant-audio-output-level') {\n      level = 'info';\n    }\n\n    const payloadData: Record<string, any> = { threshold };\n\n    if (value) {\n      if (value instanceof Array) {\n        payloadData.values = value.map((val: any) => {\n          if (typeof val === 'number') {\n            return Math.round(val * 100) / 100;\n          }\n\n          return value;\n        });\n      } else {\n        payloadData.value = value;\n      }\n    }\n\n    this._publisher.post(level, groupName, warningName, { data: payloadData }, this);\n\n    if (warningName !== 'constant-audio-output-level') {\n      const emitName = wasCleared ? 'warning-cleared' : 'warning';\n      this.emit(emitName, warningName);\n    }\n  }\n\n  /**\n   * Transition to {@link ConnectionStatus.Open} if criteria is met.\n   */\n  private _maybeTransitionToOpen(): void {\n    if (this.mediaStream && this.mediaStream.status === 'open' && this._isAnswered) {\n      this._status = Connection.State.Open;\n      this.emit('accept', this);\n    }\n  }\n\n  /**\n   * Called when the {@link Connection} is answered.\n   * @param payload\n   */\n  private _onAnswer = (payload: Record<string, any>): void => {\n    // answerOnBridge=false will send a 183 which we need to catch in _onRinging when\n    // the enableRingingState flag is disabled. In that case, we will receive a 200 after\n    // the callee accepts the call firing a second `accept` event if we don't\n    // short circuit here.\n    if (this._isAnswered) {\n      return;\n    }\n\n    this._setCallSid(payload);\n    this._isAnswered = true;\n    this._maybeTransitionToOpen();\n  }\n\n  /**\n   * Called when the {@link Connection} is cancelled.\n   * @param payload\n   */\n  private _onCancel = (payload: Record<string, any>): void => {\n    // (rrowland) Is this check necessary? Verify, and if so move to pstream / VSP module.\n    const callsid = payload.callsid;\n    if (this.parameters.CallSid === callsid) {\n      this._status = Connection.State.Closed;\n      this.emit('cancel');\n      this.pstream.removeListener('cancel', this._onCancel);\n    }\n  }\n\n  /**\n   * Called when the {@link Connection} is hung up.\n   * @param payload\n   */\n  private _onHangup = (payload: Record<string, any>): void => {\n    /**\n     *  see if callsid passed in message matches either callsid or outbound id\n     *  connection should always have either callsid or outbound id\n     *  if no callsid passed hangup anyways\n     */\n    if (payload.callsid && (this.parameters.CallSid || this.outboundConnectionId)) {\n      if (payload.callsid !== this.parameters.CallSid\n          && payload.callsid !== this.outboundConnectionId) {\n        return;\n      }\n    } else if (payload.callsid) {\n      // hangup is for another connection\n      return;\n    }\n\n    this._log.info('Received HANGUP from gateway');\n    if (payload.error) {\n      const error = {\n        code: payload.error.code || 31000,\n        connection: this,\n        message: payload.error.message || 'Error sent from gateway in HANGUP',\n      };\n      this._log.error('Received an error from the gateway:', error);\n      this.emit('error', error);\n    }\n    this.sendHangup = false;\n    this._publisher.info('connection', 'disconnected-by-remote', null, this);\n    this._disconnect(null, true);\n    this._cleanupEventListeners();\n  }\n\n  /**\n   * When we get a RINGING signal from PStream, update the {@link Connection} status.\n   * @param payload\n   */\n  private _onRinging = (payload: Record<string, any>): void => {\n    this._setCallSid(payload);\n\n    // If we're not in 'connecting' or 'ringing' state, this event was received out of order.\n    if (this._status !== Connection.State.Connecting && this._status !== Connection.State.Ringing) {\n      return;\n    }\n\n    const hasEarlyMedia = !!payload.sdp;\n    if (this.options.enableRingingState) {\n      this._status = Connection.State.Ringing;\n      this._publisher.info('connection', 'outgoing-ringing', { hasEarlyMedia }, this);\n      this.emit('ringing', hasEarlyMedia);\n    // answerOnBridge=false will send a 183, which we need to interpret as `answer` when\n    // the enableRingingState flag is disabled in order to maintain a non-breaking API from 1.4.24\n    } else if (hasEarlyMedia) {\n      this._onAnswer(payload);\n    }\n  }\n\n  /**\n   * Called each time RTCMonitor emits a sample.\n   * Emits stats event and batches the call stats metrics and sends them to Insights.\n   * @param sample\n   */\n  private _onRTCSample = (sample: RTCSample): void => {\n    const callMetrics: Connection.CallMetrics = {\n      ...sample,\n      audioInputLevel: Math.round(average(this._internalInputVolumes)),\n      audioOutputLevel: Math.round(average(this._internalOutputVolumes)),\n      inputVolume: this._latestInputVolume,\n      outputVolume: this._latestOutputVolume,\n    };\n\n    this._internalInputVolumes.splice(0);\n    this._internalOutputVolumes.splice(0);\n    this._codec = callMetrics.codecName;\n\n    this._metricsSamples.push(callMetrics);\n    if (this._metricsSamples.length >= METRICS_BATCH_SIZE) {\n      this._publishMetrics();\n    }\n\n    this.emit('sample', sample);\n  }\n\n  /**\n   * Post an event to Endpoint Analytics indicating that the end user\n   *   has ignored a request for feedback.\n   */\n  private _postFeedbackDeclined(): Promise<void> {\n    return this._publisher.info('feedback', 'received-none', null, this, true);\n  }\n\n  /**\n   * Publish the current set of queued metrics samples to Insights.\n   */\n  private _publishMetrics(): void {\n    if (this._metricsSamples.length === 0) {\n      return;\n    }\n\n    this._publisher.postMetrics(\n      'quality-metrics-samples', 'metrics-sample', this._metricsSamples.splice(0), this._createMetricPayload(), this,\n    ).catch((e: any) => {\n      this._log.warn('Unable to post metrics to Insights. Received error:', e);\n    });\n  }\n\n  /**\n   * Re-emit an RTCMonitor warning as a {@link Connection}.warning or .warning-cleared event.\n   * @param warningData\n   * @param wasCleared - Whether this is a -cleared or -raised event.\n   */\n  private _reemitWarning = (warningData: Record<string, any>, wasCleared?: boolean): void => {\n    const groupPrefix = /^audio/.test(warningData.name) ?\n      'audio-level-' : 'network-quality-';\n\n    const warningPrefix = WARNING_PREFIXES[warningData.threshold.name];\n    const warningName = warningPrefix + WARNING_NAMES[warningData.name];\n\n    this._emitWarning(groupPrefix, warningName, warningData.threshold.value,\n                      warningData.values || warningData.value, wasCleared);\n  }\n\n  /**\n   * Re-emit an RTCMonitor warning-cleared as a .warning-cleared event.\n   * @param warningData\n   */\n  private _reemitWarningCleared = (warningData: Record<string, any>): void => {\n    this._reemitWarning(warningData, true);\n  }\n\n  /**\n   * Set the CallSid\n   * @param payload\n   */\n  private _setCallSid(payload: Record<string, string>): void {\n    const callSid = payload.callsid;\n    if (!callSid) { return; }\n\n    this.parameters.CallSid = callSid;\n    this.mediaStream.callSid = callSid;\n  }\n}\n\nnamespace Connection {\n  /**\n   * Emitted when the {@link Connection} is accepted.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('accept', connection => { })`\n   * @event\n   */\n  declare function acceptEvent(connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} is canceled.\n   * @example `connection.on('cancel', () => { })`\n   * @event\n   */\n  declare function cancelEvent(): void;\n\n  /**\n   * Emitted when the {@link Connection} is disconnected.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('disconnect', connection => { })`\n   * @event\n   */\n  declare function disconnectEvent(connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} receives an error.\n   * @param error\n   * @example `connection.on('error', error => { })`\n   * @event\n   */\n  declare function errorEvent(error: Connection.Error): void;\n\n  /**\n   * Emitted when the {@link Connection} is muted or unmuted.\n   * @param isMuted - Whether the {@link Connection} is muted.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('mute', (isMuted, connection) => { })`\n   * @event\n   */\n  declare function muteEvent(isMuted: boolean, connection: Connection): void;\n\n  /**\n   * Emitted when the {@link Connection} is rejected.\n   * @param connection - The {@link Connection}.\n   * @example `connection.on('reject', connection => { })`\n   * @event\n   */\n  declare function rejectEvent(connection: Connection): void;\n\n  /**\n   * Emitted on `requestAnimationFrame` (up to 60fps, depending on browser) with\n   *   the current input and output volumes, as a percentage of maximum\n   *   volume, between -100dB and -30dB. Represented by a floating point\n   *   number.\n   * @param inputVolume - A floating point number between 0.0 and 1.0 inclusive.\n   * @param outputVolume - A floating point number between 0.0 and 1.0 inclusive.\n   * @example `connection.on('volume', (inputVolume, outputVolume) => { })`\n   * @event\n   */\n  declare function volumeEvent(inputVolume: number, outputVolume: number): void;\n\n  /**\n   * Emitted when the {@link Connection} gets a webrtc sample object.\n   * This event is published every second.\n   * @param sample\n   * @example `connection.on('sample', sample => { })`\n   * @event\n   */\n  declare function sampleEvent(sample: RTCSample): void;\n\n  /**\n   * Possible states of the {@link Connection}.\n   */\n  export enum State {\n    Closed = 'closed',\n    Connecting = 'connecting',\n    Open = 'open',\n    Pending = 'pending',\n    Ringing = 'ringing',\n  }\n\n  /**\n   * Different issues that may have been experienced during a call, that can be\n   * reported to Twilio Insights via {@link Connection}.postFeedback().\n   */\n  export enum FeedbackIssue {\n    AudioLatency = 'audio-latency',\n    ChoppyAudio = 'choppy-audio',\n    DroppedCall = 'dropped-call',\n    Echo = 'echo',\n    NoisyCall = 'noisy-call',\n    OneWayAudio = 'one-way-audio',\n  }\n\n  /**\n   * A rating of call quality experienced during a call, to be reported to Twilio Insights\n   * via {@link Connection}.postFeedback().\n   */\n  export enum FeedbackScore {\n    One = 1,\n    Two,\n    Three,\n    Four,\n    Five,\n  }\n\n  /**\n   * The directionality of the {@link Connection}, whether incoming or outgoing.\n   */\n  export enum CallDirection {\n    Incoming = 'INCOMING',\n    Outgoing = 'OUTGOING',\n  }\n\n  /**\n   * Valid audio codecs to use for the media connection.\n   */\n  export enum Codec {\n    Opus = 'opus',\n    PCMU = 'pcmu',\n  }\n\n  /**\n   * The error format used by errors emitted from {@link Connection}.\n   */\n  export interface Error {\n    /**\n     * Error code\n     */\n    code: number;\n\n    /**\n     * Reference to the {@link Connection}\n     */\n    connection: Connection;\n\n    /**\n     * The info object from rtc/peerconnection. May contain code and message (duplicated here).\n     */\n    info: { code?: number, message?: string };\n\n    /**\n     * Error message\n     */\n    message: string;\n  }\n\n  /**\n   * Mandatory config options to be passed to the {@link Connection} constructor.\n   * @private\n   */\n  export interface Config {\n    /**\n     * An AudioHelper instance to be used for input/output devices.\n     */\n    audioHelper: IAudioHelper;\n\n    /**\n     * A method to use for getUserMedia.\n     */\n    getUserMedia: (constraints: MediaStreamConstraints) => Promise<MediaStream>;\n\n    /**\n     * Whether or not the browser uses unified-plan SDP by default.\n     */\n    isUnifiedPlanDefault: boolean;\n\n    /**\n     * The PStream instance to use for Twilio call signaling.\n     */\n    pstream: IPStream;\n\n    /**\n     * An EventPublisher instance to use for publishing events\n     */\n    publisher: IPublisher;\n\n    /**\n     * A Map of Sounds to play.\n     */\n    soundcache: Map<Device.SoundName, ISound>;\n  }\n\n  /**\n   * Options to be passed to the {@link Connection} constructor.\n   * @private\n   */\n  export interface Options {\n    /**\n     * Audio Constraints to pass to getUserMedia when making or accepting a Call.\n     * This is placed directly under `audio` of the MediaStreamConstraints object.\n     */\n    audioConstraints?: MediaTrackConstraints | boolean;\n\n    /**\n     * A method to call before Connection.accept is processed.\n     */\n    beforeAccept?: (connection: Connection) => void;\n\n    /**\n     * Custom format context parameters associated with this call.\n     */\n    callParameters?: Record<string, string>;\n\n    /**\n     * An ordered array of codec names, from most to least preferred.\n     */\n    codecPreferences?: Codec[];\n\n    /**\n     * Whether to enable debug level logging.\n     */\n    debug?: boolean;\n\n    /**\n     * A DialTone player, to play mock DTMF sounds.\n     */\n    dialtonePlayer?: DialtonePlayer;\n\n    /**\n     * Whether or not to enable DSCP.\n     */\n    dscp?: boolean;\n\n    /**\n     * Whether the ringing state should be enabled.\n     */\n    enableRingingState?: boolean;\n\n    /**\n     * The gateway currently connected to.\n     */\n    gateway?: string;\n\n    /**\n     * A method that returns the current input MediaStream set on {@link Device}.\n     */\n    getInputStream?: () => MediaStream;\n\n    /**\n     * A method that returns the current SinkIDs set on {@link Device}.\n     */\n    getSinkIds?: () => string[];\n\n    /**\n     * Custom MediaStream (PeerConnection) constructor. Overrides mediaStreamFactory (deprecated).\n     */\n    MediaStream?: IPeerConnection;\n\n    /**\n     * Custom MediaStream (PeerConnection) constructor (deprecated)\n     */\n    mediaStreamFactory?: IPeerConnection;\n\n    /**\n     * The offer SDP, if this is an incoming call.\n     */\n    offerSdp?: string | null;\n\n    /**\n     * The Region currently connected to.\n     */\n    region?: Region;\n\n    /**\n     * An RTCConfiguration to pass to the RTCPeerConnection constructor.\n     */\n    rtcConfiguration?: RTCConfiguration;\n\n    /**\n     * RTC Constraints to pass to getUserMedia when making or accepting a Call.\n     * The format of this object depends on browser.\n     */\n    rtcConstraints?: MediaStreamConstraints;\n\n    /**\n     * An override for the RTCMonitor dependency.\n     */\n    RTCMonitor?: new () => RTCMonitor;\n\n    /**\n     * The region passed to {@link Device} on setup.\n     */\n    selectedRegion?: string;\n\n    /**\n     * Whether the disconnect sound should be played.\n     */\n    shouldPlayDisconnect?: () => boolean;\n\n    /**\n     * TwiML params for the call. May be set for either outgoing or incoming calls.\n     */\n    twimlParams?: Record<string, any>;\n\n    /**\n     * Whether to enable warn level logging.\n     */\n    warnings?: boolean;\n  }\n\n  /**\n   * Call metrics published to Insight Metrics.\n   * This include rtc samples and audio information.\n   * @private\n   */\n  export interface CallMetrics extends RTCSample {\n    /**\n     * Audio input level between 0 and 32767, representing -100 to -30 dB.\n     */\n    audioInputLevel: number;\n\n    /**\n     * Audio output level between 0 and 32767, representing -100 to -30 dB.\n     */\n    audioOutputLevel: number;\n    /**\n     * Percentage of maximum volume, between 0.0 to 1.0, representing -100 to -30 dB.\n     */\n    inputVolume: number;\n\n    /**\n     * Percentage of maximum volume, between 0.0 to 1.0, representing -100 to -30 dB.\n     */\n    outputVolume: number;\n  }\n}\n\nfunction generateTempCallSid() {\n  return 'TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n    /* tslint:disable:no-bitwise */\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    /* tslint:enable:no-bitwise */\n    return v.toString(16);\n  });\n}\n\nexport default Connection;\n"]}