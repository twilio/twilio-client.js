{"version":3,"file":"device.js","sourceRoot":"","sources":["../../lib/twilio/device.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @packageDocumentation\n * @module Voice\n * @preferred\n * @publicapi\n */\nimport { EventEmitter } from 'events';\nimport { levels as LogLevels, LogLevelDesc } from 'loglevel';\nimport AudioHelper from './audiohelper';\nimport Call from './call';\nimport DialtonePlayer from './dialtonePlayer';\nimport {\n  AuthorizationErrors,\n  ClientErrors,\n  GeneralErrors,\n  getErrorByCode,\n  hasErrorByCode,\n  InvalidArgumentError,\n  InvalidStateError,\n  NotSupportedError,\n  TwilioError,\n} from './errors';\nimport Log from './log';\nimport { PreflightTest } from './preflight/preflight';\nimport {\n  getChunderURIs,\n  getRegionShortcode,\n  Region,\n  regionToEdge,\n} from './regions';\nimport {\n  isLegacyEdge,\n  isUnifiedPlanDefault,\n  queryToJson,\n} from './util';\n\nconst C = require('./constants');\nconst Publisher = require('./eventpublisher');\nconst PStream = require('./pstream');\nconst rtc = require('./rtc');\nconst getUserMedia = require('./rtc/getusermedia');\nconst Sound = require('./sound');\n\n// Placeholders until we convert the respective files to TypeScript.\n/**\n * @private\n */\nexport type IPStream = any;\n/**\n * @private\n */\nexport type IPublisher = any;\n/**\n * @private\n */\nexport type ISound = any;\n\nconst REGISTRATION_INTERVAL = 30000;\nconst RINGTONE_PLAY_TIMEOUT = 2000;\nconst PUBLISHER_PRODUCT_NAME = 'twilio-js-sdk';\nconst INVALID_TOKEN_MESSAGE = 'Parameter \"token\" must be of type \"string\".';\n\ndeclare const RTCRtpTransceiver: any;\ndeclare const webkitAudioContext: typeof AudioContext;\n\n/**\n * Options that may be passed to the {@link Device} constructor for internal testing.\n * @private\n */\nexport interface IExtendedDeviceOptions extends Device.Options {\n  /**\n   * Custom {@link AudioHelper} constructor\n   */\n  AudioHelper?: typeof AudioHelper;\n\n  /**\n   * The max amount of time in milliseconds to allow stream (re)-connect\n   * backoffs.\n   */\n  backoffMaxMs?: number;\n\n  /**\n   * Custom {@link Call} constructor\n   */\n  Call?: typeof Call;\n\n  /**\n   * Hostname of the signaling gateway to connect to.\n   */\n  chunderw?: string | string[];\n\n  /**\n   * Hostname of the event gateway to connect to.\n   */\n  eventgw?: string;\n\n  /**\n   * File input stream to use instead of reading from mic\n   */\n  fileInputStream?: MediaStream;\n\n  /**\n   * Ignore browser support, disabling the exception that is thrown when neither WebRTC nor\n   * ORTC are supported.\n   */\n  ignoreBrowserSupport?: boolean;\n\n  /**\n   * MediaStream constructor.\n   */\n  MediaStream?: typeof MediaStream;\n\n  /**\n   * Whether this is a preflight call or not\n   */\n  preflight?: boolean;\n\n  /**\n   * Custom PStream constructor\n   */\n  PStream?: IPStream;\n\n  /**\n   * Custom Publisher constructor\n   */\n  Publisher?: IPublisher;\n\n  /**\n   * Whether or not to publish events to insights using {@link Device._publisher}.\n   */\n  publishEvents?: boolean;\n\n  /**\n   * MediaStreamConstraints to pass to getUserMedia when making or accepting a Call.\n   */\n  rtcConstraints?: Call.AcceptOptions['rtcConstraints'];\n\n  /**\n   * Custom Sound constructor\n   */\n  Sound?: ISound;\n}\n\n/**\n * A sound definition used to initialize a Sound file.\n * @private\n */\nexport interface ISoundDefinition {\n  /**\n   * Name of the sound file.\n   */\n  filename: string;\n\n  /**\n   * The amount of time this sound file should play before being stopped automatically.\n   */\n  maxDuration?: number;\n\n  /**\n   * Whether or not this sound should loop after playthrough finishes.\n   */\n  shouldLoop?: boolean;\n}\n\n/**\n * Twilio Device. Allows registration for incoming calls, and placing outgoing calls.\n * @publicapi\n */\nclass Device extends EventEmitter {\n  /**\n   * The AudioContext to be used by {@link Device} instances.\n   * @private\n   */\n  static get audioContext(): AudioContext | undefined {\n    return Device._audioContext;\n  }\n\n  /**\n   * Which sound file extension is supported.\n   * @private\n   */\n  static get extension(): 'mp3' | 'ogg' {\n    // NOTE(mroberts): Node workaround.\n    const a: any = typeof document !== 'undefined'\n      ? document.createElement('audio') : { canPlayType: false };\n\n    let canPlayMp3;\n    try {\n      canPlayMp3 = a.canPlayType && !!a.canPlayType('audio/mpeg').replace(/no/, '');\n    } catch (e) {\n      canPlayMp3 = false;\n    }\n\n    let canPlayVorbis;\n    try {\n      canPlayVorbis = a.canPlayType && !!a.canPlayType('audio/ogg;codecs=\\'vorbis\\'').replace(/no/, '');\n    } catch (e) {\n      canPlayVorbis = false;\n    }\n\n    return (canPlayVorbis && !canPlayMp3) ? 'ogg' : 'mp3';\n  }\n\n  /**\n   * Whether or not this SDK is supported by the current browser.\n   */\n  static get isSupported(): boolean { return rtc.enabled(); }\n\n  /**\n   * Package name of the SDK.\n   */\n  static get packageName(): string { return C.PACKAGE_NAME; }\n\n  /**\n   * Run some tests to identify issues, if any, prohibiting successful calling.\n   * @param token - A Twilio JWT token string\n   * @param options\n   */\n  static runPreflight(token: string, options?: PreflightTest.Options): PreflightTest {\n    return new PreflightTest(token, { audioContext: Device._getOrCreateAudioContext(), ...options });\n  }\n\n  /**\n   * String representation of {@link Device} class.\n   * @private\n   */\n  static toString(): string {\n    return '[Twilio.Device class]';\n  }\n\n  /**\n   * Current SDK version.\n   */\n  static get version(): string { return C.RELEASE_VERSION; }\n\n  /**\n   * An AudioContext to share between {@link Device}s.\n   */\n  private static _audioContext?: AudioContext;\n\n  private static _defaultSounds: Record<string, ISoundDefinition> = {\n    disconnect: { filename: 'disconnect', maxDuration: 3000 },\n    dtmf0: { filename: 'dtmf-0', maxDuration: 1000 },\n    dtmf1: { filename: 'dtmf-1', maxDuration: 1000 },\n    dtmf2: { filename: 'dtmf-2', maxDuration: 1000 },\n    dtmf3: { filename: 'dtmf-3', maxDuration: 1000 },\n    dtmf4: { filename: 'dtmf-4', maxDuration: 1000 },\n    dtmf5: { filename: 'dtmf-5', maxDuration: 1000 },\n    dtmf6: { filename: 'dtmf-6', maxDuration: 1000 },\n    dtmf7: { filename: 'dtmf-7', maxDuration: 1000 },\n    dtmf8: { filename: 'dtmf-8', maxDuration: 1000 },\n    dtmf9: { filename: 'dtmf-9', maxDuration: 1000 },\n    dtmfh: { filename: 'dtmf-hash', maxDuration: 1000 },\n    dtmfs: { filename: 'dtmf-star', maxDuration: 1000 },\n    incoming: { filename: 'incoming', shouldLoop: true },\n    outgoing: { filename: 'outgoing', maxDuration: 3000 },\n  };\n\n  /**\n   * A DialtonePlayer to play mock DTMF sounds through.\n   */\n  private static _dialtonePlayer?: DialtonePlayer;\n\n  /**\n   * Whether or not the browser uses unified-plan SDP by default.\n   */\n  private static _isUnifiedPlanDefault: boolean | undefined;\n\n  /**\n   * Initializes the AudioContext instance shared across the Voice SDK,\n   * or returns the existing instance if one has already been initialized.\n   */\n  private static _getOrCreateAudioContext(): AudioContext | undefined {\n    if (!Device._audioContext) {\n      if (typeof AudioContext !== 'undefined') {\n        Device._audioContext = new AudioContext();\n      } else if (typeof webkitAudioContext !== 'undefined') {\n        Device._audioContext = new webkitAudioContext();\n      }\n    }\n    return Device._audioContext;\n  }\n\n  /**\n   * The currently active {@link Call}, if there is one.\n   */\n  private _activeCall: Call | null = null;\n\n  /**\n   * The AudioHelper instance associated with this {@link Device}.\n   */\n  private _audio: AudioHelper | null = null;\n\n  /**\n   * {@link Device._confirmClose} bound to the specific {@link Device} instance.\n   */\n  private _boundConfirmClose: typeof Device.prototype._confirmClose;\n\n  /**\n   * {@link Device.destroy} bound to the specific {@link Device} instance.\n   */\n  private _boundDestroy: typeof Device.prototype.destroy;\n\n  /**\n   * An audio input MediaStream to pass to new {@link Call} instances.\n   */\n  private _callInputStream: MediaStream | null = null;\n\n  /**\n   * An array of {@link Call}s. Though only one can be active, multiple may exist when there\n   * are multiple incoming, unanswered {@link Call}s.\n   */\n  private _calls: Call[] = [];\n\n  /**\n   * An array of {@link Device} IDs to be used to play sounds through, to be passed to\n   * new {@link Call} instances.\n   */\n  private _callSinkIds: string[] = ['default'];\n\n  /**\n   * The list of chunder URIs that will be passed to PStream\n   */\n  private _chunderURIs: string[] = [];\n\n  /**\n   * Default options used by {@link Device}.\n   */\n  private readonly _defaultOptions: IExtendedDeviceOptions = {\n    allowIncomingWhileBusy: false,\n    closeProtection: false,\n    codecPreferences: [Call.Codec.PCMU, Call.Codec.Opus],\n    dscp: true,\n    eventgw: 'eventgw.twilio.com',\n    forceAggressiveIceNomination: false,\n    logLevel: LogLevels.ERROR,\n    preflight: false,\n    sounds: { },\n  };\n\n  /**\n   * The name of the edge the {@link Device} is connected to.\n   */\n  private _edge: string | null = null;\n\n  /**\n   * Whether each sound is enabled.\n   */\n  private _enabledSounds: Record<Device.ToggleableSound, boolean> = {\n    [Device.SoundName.Disconnect]: true,\n    [Device.SoundName.Incoming]: true,\n    [Device.SoundName.Outgoing]: true,\n  };\n\n  /**\n   * Whether SDK is run as a browser extension\n   */\n  private _isBrowserExtension: boolean;\n\n  /**\n   * An instance of Logger to use.\n   */\n  private _log: Log = Log.getInstance();\n\n  /**\n   * Network related information\n   * See https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API\n   */\n  private _networkInformation: any;\n\n  /**\n   * The options passed to {@link Device} constructor or {@link Device.updateOptions}.\n   */\n  private _options: IExtendedDeviceOptions = { };\n\n  /**\n   * An Insights Event Publisher.\n   */\n  private _publisher: IPublisher | null = null;\n\n  /**\n   * The region the {@link Device} is connected to.\n   */\n  private _region: string | null = null;\n\n  /**\n   * A timeout ID for a setTimeout schedule to re-register the {@link Device}.\n   */\n  private _regTimer: NodeJS.Timer | null = null;\n\n  /**\n   * Boolean representing whether or not the {@link Device} was registered when\n   * receiving a signaling `offline`. Determines if the {@link Device} attempts\n   * a `re-register` once signaling is re-established when receiving a\n   * `connected` event from the stream.\n   */\n  private _shouldReRegister: boolean = false;\n\n  /**\n   * A Map of Sounds to play.\n   */\n  private _soundcache: Map<Device.SoundName, ISound> = new Map();\n\n  /**\n   * The current status of the {@link Device}.\n   */\n  private _state: Device.State = Device.State.Unregistered;\n\n  /**\n   * A map from {@link Device.State} to {@link Device.EventName}.\n   */\n  private readonly _stateEventMapping: Record<Device.State, Device.EventName> = {\n    [Device.State.Destroyed]: Device.EventName.Destroyed,\n    [Device.State.Unregistered]: Device.EventName.Unregistered,\n    [Device.State.Registering]: Device.EventName.Registering,\n    [Device.State.Registered]: Device.EventName.Registered,\n  };\n\n  /**\n   * The Signaling stream.\n   */\n  private _stream: IPStream | null = null;\n\n  /**\n   * A promise that will resolve when the Signaling stream is ready.\n   */\n  private _streamConnectedPromise: Promise<IPStream> | null = null;\n\n  /**\n   * The JWT string currently being used to authenticate this {@link Device}.\n   */\n  private _token: string;\n\n  /**\n   * Construct a {@link Device} instance. The {@link Device} can be registered\n   * to make and listen for calls using {@link Device.register}.\n   * @constructor\n   * @param options\n   */\n  constructor(token: string, options: Device.Options = { }) {\n    super();\n\n    this.updateToken(token);\n\n    if (isLegacyEdge()) {\n      throw new NotSupportedError(\n        'Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) ' +\n        'is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. ' +\n        'Please see this documentation for a list of supported browsers ' +\n        'https://www.twilio.com/docs/voice/client/javascript#supported-browsers',\n      );\n    }\n\n    if (!Device.isSupported && (options as IExtendedDeviceOptions).ignoreBrowserSupport) {\n      if (window && window.location && window.location.protocol === 'http:') {\n        throw new NotSupportedError(`twilio.js wasn't able to find WebRTC browser support. \\\n          This is most likely because this page is served over http rather than https, \\\n          which does not support WebRTC in many browsers. Please load this page over https and \\\n          try again.`);\n      }\n\n      throw new NotSupportedError(`twilio.js 1.3+ SDKs require WebRTC browser support. \\\n        For more information, see <https://www.twilio.com/docs/api/client/twilio-js>. \\\n        If you have any questions about this announcement, please contact \\\n        Twilio Support at <help@twilio.com>.`);\n    }\n\n    if (window) {\n      const root: any = window as any;\n      const browser: any = root.msBrowser || root.browser || root.chrome;\n\n      this._isBrowserExtension = (!!browser && !!browser.runtime && !!browser.runtime.id)\n        || (!!root.safari && !!root.safari.extension);\n    }\n\n    if (this._isBrowserExtension) {\n      this._log.info('Running as browser extension.');\n    }\n\n    if (navigator) {\n      const n = navigator as any;\n      this._networkInformation = n.connection\n        || n.mozConnection\n        || n.webkitConnection;\n    }\n\n    if (this._networkInformation && typeof this._networkInformation.addEventListener === 'function') {\n      this._networkInformation.addEventListener('change', this._publishNetworkChange);\n    }\n\n    Device._getOrCreateAudioContext();\n\n    if (Device._audioContext) {\n      if (!Device._dialtonePlayer) {\n        Device._dialtonePlayer = new DialtonePlayer(Device._audioContext);\n      }\n    }\n\n    if (typeof Device._isUnifiedPlanDefault === 'undefined') {\n      Device._isUnifiedPlanDefault = typeof window !== 'undefined'\n        && typeof RTCPeerConnection !== 'undefined'\n        && typeof RTCRtpTransceiver !== 'undefined'\n      ? isUnifiedPlanDefault(window, window.navigator, RTCPeerConnection, RTCRtpTransceiver)\n      : false;\n    }\n\n    this._boundDestroy = this.destroy.bind(this);\n    this._boundConfirmClose = this._confirmClose.bind(this);\n\n    if (typeof window !== 'undefined' && window.addEventListener) {\n      window.addEventListener('unload', this._boundDestroy);\n      window.addEventListener('pagehide', this._boundDestroy);\n    }\n\n    this.updateOptions(options);\n  }\n\n  /**\n   * Return the {@link AudioHelper} used by this {@link Device}.\n   */\n  get audio(): AudioHelper | null {\n    return this._audio;\n  }\n\n  /**\n   * Make an outgoing Call.\n   * @param options\n   */\n  async connect(options: Device.ConnectOptions = { }): Promise<Call> {\n    this._throwIfDestroyed();\n\n    if (this._activeCall) {\n      throw new InvalidStateError('A Call is already active');\n    }\n\n    const activeCall = this._activeCall = await this._makeCall(options.params || { }, {\n      rtcConfiguration: options.rtcConfiguration,\n    });\n\n    // Make sure any incoming calls are ignored\n    this._calls.splice(0).forEach(call => call.ignore());\n\n    // Stop the incoming sound if it's playing\n    this._soundcache.get(Device.SoundName.Incoming).stop();\n\n    activeCall.accept({ rtcConstraints: options.rtcConstraints });\n    this._publishNetworkChange();\n    return activeCall;\n  }\n\n  /**\n   * Return the calls that this {@link Device} is maintaining.\n   */\n  get calls(): Call[] {\n    return this._calls;\n  }\n\n  /**\n   * Destroy the {@link Device}, freeing references to be garbage collected.\n   */\n  destroy(): void {\n    this.disconnectAll();\n    this._stopRegistrationTimer();\n\n    if (this._audio) {\n      this._audio._unbind();\n    }\n\n    this._destroyStream();\n    this._destroyPublisher();\n    this._destroyAudioHelper();\n\n    if (this._networkInformation && typeof this._networkInformation.removeEventListener === 'function') {\n      this._networkInformation.removeEventListener('change', this._publishNetworkChange);\n    }\n\n    if (typeof window !== 'undefined' && window.removeEventListener) {\n      window.removeEventListener('beforeunload', this._boundConfirmClose);\n      window.removeEventListener('unload', this._boundDestroy);\n      window.removeEventListener('pagehide', this._boundDestroy);\n    }\n\n    this._setState(Device.State.Destroyed);\n  }\n\n  /**\n   * Disconnect all {@link Call}s.\n   */\n  disconnectAll(): void {\n    const calls = this._calls.splice(0);\n    calls.forEach((call: Call) => call.disconnect());\n\n    if (this._activeCall) {\n      this._activeCall.disconnect();\n    }\n  }\n\n  /**\n   * Returns the {@link Edge} value the {@link Device} is currently connected\n   * to. The value will be `null` when the {@link Device} is offline.\n   */\n  get edge(): string | null {\n    return this._edge;\n  }\n\n  /**\n   * Whether the Device is currently on an active Call.\n   */\n  get isBusy(): boolean {\n    return !!this._activeCall;\n  }\n\n  /**\n   * Register the `Device` to the Twilio backend, allowing it to receive calls.\n   */\n  async register(): Promise<void> {\n    if (this.state !== Device.State.Unregistered) {\n      throw new InvalidStateError(\n        `Attempt to register when device is in state \"${this.state}\". ` +\n        `Must be \"${Device.State.Unregistered}\".`,\n      );\n    }\n\n    this._setState(Device.State.Registering);\n\n    const stream = await (this._streamConnectedPromise || this._setupStream());\n    const streamReadyPromise = new Promise(resolve => {\n      this.once(Device.State.Registered, resolve);\n    });\n    await this._sendPresence(true);\n    await streamReadyPromise;\n  }\n\n  /**\n   * Get the state of this {@link Device} instance\n   */\n  get state(): Device.State {\n    return this._state;\n  }\n\n  /**\n   * Get the token used by this {@link Device}.\n   */\n  get token(): string | null {\n    return this._token;\n  }\n\n  /**\n   * String representation of {@link Device} instance.\n   * @private\n   */\n  toString() {\n    return '[Twilio.Device instance]';\n  }\n\n  /**\n   * Unregister the `Device` to the Twilio backend, disallowing it to receive\n   * calls.\n   */\n  async unregister(): Promise<void> {\n    if (this.state !== Device.State.Registered) {\n      throw new InvalidStateError(\n        `Attempt to unregister when device is in state \"${this.state}\". ` +\n        `Must be \"${Device.State.Registered}\".`,\n      );\n    }\n\n    this._shouldReRegister = false;\n\n    const stream = await this._streamConnectedPromise;\n    const streamOfflinePromise = new Promise(resolve => {\n      stream.on('offline', resolve);\n    });\n    await this._sendPresence(false);\n    await streamOfflinePromise;\n  }\n\n  /**\n   * Set the options used within the {@link Device}.\n   * @param options\n   */\n  updateOptions(options: Device.Options = { }): void {\n    if (this.state === Device.State.Destroyed) {\n      throw new InvalidStateError(\n        `Attempt to \"updateOptions\" when device is in state \"${this.state}\".`,\n      );\n    }\n\n    this._options = { ...this._defaultOptions, ...this._options, ...options };\n\n    const originalChunderURIs: Set<string> = new Set(this._chunderURIs);\n\n    const chunderw = typeof this._options.chunderw === 'string'\n      ? [this._options.chunderw]\n      : Array.isArray(this._options.chunderw) && this._options.chunderw;\n\n    const newChunderURIs = this._chunderURIs = (\n      chunderw || getChunderURIs(\n        this._options.edge,\n        undefined,\n        this._log.warn.bind(this._log),\n      )\n    ).map((uri: string) => `wss://${uri}/signal`);\n\n    let hasChunderURIsChanged =\n      originalChunderURIs.size !== newChunderURIs.length;\n\n    if (!hasChunderURIsChanged) {\n      for (const uri of newChunderURIs) {\n        if (!originalChunderURIs.has(uri)) {\n          hasChunderURIsChanged = true;\n          break;\n        }\n      }\n    }\n\n    if (this.isBusy && hasChunderURIsChanged) {\n      throw new InvalidStateError('Cannot change Edge while on an active Call');\n    }\n\n    this._log.setDefaultLevel(\n      typeof this._options.logLevel === 'number'\n        ? this._options.logLevel\n        : LogLevels.ERROR,\n    );\n\n    if (this._options.dscp) {\n      if (!this._options.rtcConstraints) {\n        this._options.rtcConstraints = { };\n      }\n      (this._options.rtcConstraints as any).optional = [{ googDscp: true }];\n    }\n\n    for (const name of Object.keys(Device._defaultSounds)) {\n      const soundDef: ISoundDefinition = Device._defaultSounds[name];\n\n      const defaultUrl: string = `${C.SOUNDS_BASE_URL}/${soundDef.filename}.${Device.extension}`\n        + `?cache=${C.RELEASE_VERSION}`;\n\n      const soundUrl: string = this._options.sounds && this._options.sounds[name as Device.SoundName] || defaultUrl;\n      const sound: any = new (this._options.Sound || Sound)(name, soundUrl, {\n        audioContext: this._options.disableAudioContextSounds ? null : Device.audioContext,\n        maxDuration: soundDef.maxDuration,\n        shouldLoop: soundDef.shouldLoop,\n      });\n\n      this._soundcache.set(name as Device.SoundName, sound);\n    }\n\n    this._setupAudioHelper();\n    this._setupPublisher();\n\n    if (hasChunderURIsChanged && this._streamConnectedPromise) {\n      this._setupStream();\n    }\n\n    // Setup close protection and make sure we clean up ongoing calls on unload.\n    if (\n      typeof window !== 'undefined' &&\n      typeof window.addEventListener === 'function' &&\n      this._options.closeProtection\n    ) {\n      window.removeEventListener('beforeunload', this._boundConfirmClose);\n      window.addEventListener('beforeunload', this._boundConfirmClose);\n    }\n  }\n\n  /**\n   * Update the token used by this {@link Device} to connect to Twilio.\n   * @param token\n   */\n  updateToken(token: string) {\n    if (this.state === Device.State.Destroyed) {\n      throw new InvalidStateError(\n        `Attempt to \"updateToken\" when device is in state \"${this.state}\".`,\n      );\n    }\n\n    if (typeof token !== 'string') {\n      throw new InvalidArgumentError(INVALID_TOKEN_MESSAGE);\n    }\n\n    this._token = token;\n\n    if (this._stream) {\n      this._stream.setToken(this._token);\n    }\n\n    if (this._publisher) {\n      this._publisher.setToken(this._token);\n    }\n  }\n\n  /**\n   * Called on window's beforeunload event if closeProtection is enabled,\n   * preventing users from accidentally navigating away from an active call.\n   * @param event\n   */\n  private _confirmClose(event: any): string {\n    if (!this._activeCall) { return ''; }\n\n    const closeProtection: boolean | string = this._options.closeProtection || false;\n    const confirmationMsg: string = typeof closeProtection !== 'string'\n      ? 'A call is currently in-progress. Leaving or reloading this page will end the call.'\n      : closeProtection;\n\n    (event || window.event).returnValue = confirmationMsg;\n    return confirmationMsg;\n  }\n\n  /**\n   * Create the default Insights payload\n   * @param call\n   */\n  private _createDefaultPayload = (call?: Call): Record<string, any> => {\n    const payload: Record<string, any> = {\n      aggressive_nomination: this._options.forceAggressiveIceNomination,\n      browser_extension: this._isBrowserExtension,\n      dscp: !!this._options.dscp,\n      ice_restart_enabled: true,\n      platform: rtc.getMediaEngine(),\n      sdk_version: C.RELEASE_VERSION,\n    };\n\n    function setIfDefined(propertyName: string, value: string | undefined | null) {\n      if (value) { payload[propertyName] = value; }\n    }\n\n    if (call) {\n      const callSid = call.parameters.CallSid;\n      setIfDefined('call_sid', /^TJ/.test(callSid) ? undefined : callSid);\n      setIfDefined('temp_call_sid', call.outboundConnectionId);\n      setIfDefined('audio_codec', call.codec);\n      payload.direction = call.direction;\n    }\n\n    setIfDefined('gateway', this._stream && this._stream.gateway);\n    setIfDefined('region', this._stream && this._stream.region);\n\n    return payload;\n  }\n\n  /**\n   * Destroy the AudioHelper.\n   */\n  private _destroyAudioHelper() {\n    if (!this._audio) { return; }\n\n    this._audio.removeAllListeners();\n    this._audio = null;\n  }\n\n  /**\n   * Destroy the publisher.\n   */\n  private _destroyPublisher() {\n    // Attempt to destroy non-existent publisher.\n    if (!this._publisher) { return; }\n\n    this._publisher = null;\n  }\n\n  /**\n   * Destroy the connection to the signaling server.\n   */\n  private _destroyStream() {\n    if (this._stream) {\n      this._stream.destroy();\n      this._stream = null;\n    }\n\n    this._streamConnectedPromise = null;\n  }\n\n  /**\n   * Find a {@link Call} by its CallSid.\n   * @param callSid\n   */\n  private _findCall(callSid: string): Call | null {\n    return this._calls.find(call => call.parameters.CallSid === callSid\n      || call.outboundConnectionId === callSid) || null;\n  }\n\n  /**\n   * Create a new {@link Call}.\n   * @param twimlParams - A flat object containing key:value pairs to be sent to the TwiML app.\n   * @param options - Options to be used to instantiate the {@link Call}.\n   */\n  private async _makeCall(twimlParams: Record<string, string>, options?: Call.Options): Promise<Call> {\n    if (typeof Device._isUnifiedPlanDefault === 'undefined') {\n      throw new InvalidStateError('Device has not been initialized.');\n    }\n\n    const config: Call.Config = {\n      audioHelper: this._audio,\n      getUserMedia,\n      isUnifiedPlanDefault: Device._isUnifiedPlanDefault,\n      pstream: await (this._streamConnectedPromise || this._setupStream()),\n      publisher: this._publisher,\n      soundcache: this._soundcache,\n    };\n\n    options = Object.assign({\n      MediaStream: this._options.MediaStream || rtc.PeerConnection,\n      beforeAccept: (currentCall: Call) => {\n        if (!this._activeCall || this._activeCall === currentCall) {\n          return;\n        }\n\n        this._activeCall.disconnect();\n        this._removeCall(this._activeCall);\n      },\n      codecPreferences: this._options.codecPreferences,\n      dialtonePlayer: Device._dialtonePlayer,\n      dscp: this._options.dscp,\n      forceAggressiveIceNomination: this._options.forceAggressiveIceNomination,\n      getInputStream: (): MediaStream | null => this._options.fileInputStream || this._callInputStream,\n      getSinkIds: (): string[] => this._callSinkIds,\n      maxAverageBitrate: this._options.maxAverageBitrate,\n      preflight: this._options.preflight,\n      rtcConstraints: this._options.rtcConstraints,\n      shouldPlayDisconnect: () => this._enabledSounds.disconnect,\n      twimlParams,\n    }, options);\n\n    const call = new (this._options.Call || Call)(config, options);\n\n    call.once('accept', () => {\n      this._removeCall(call);\n      this._activeCall = call;\n      if (this._audio) {\n        this._audio._maybeStartPollingVolume();\n      }\n\n      if (call.direction === Call.CallDirection.Outgoing && this._enabledSounds.outgoing) {\n        this._soundcache.get(Device.SoundName.Outgoing).play();\n      }\n\n      const data: any = { edge: this._edge || this._region };\n      if (this._options.edge) {\n        data['selected_edge'] = Array.isArray(this._options.edge)\n          ? this._options.edge\n          : [this._options.edge];\n      }\n\n      this._publisher.info('settings', 'edge', data, call);\n    });\n\n    call.addListener('error', (error: TwilioError) => {\n      if (call.status() === 'closed') {\n        this._removeCall(call);\n      }\n      if (this._audio) {\n        this._audio._maybeStopPollingVolume();\n      }\n      this._maybeStopIncomingSound();\n    });\n\n    call.once('cancel', () => {\n      this._log.info(`Canceled: ${call.parameters.CallSid}`);\n      this._removeCall(call);\n      if (this._audio) {\n        this._audio._maybeStopPollingVolume();\n      }\n      this._maybeStopIncomingSound();\n    });\n\n    call.once('disconnect', () => {\n      if (this._audio) {\n        this._audio._maybeStopPollingVolume();\n      }\n      this._removeCall(call);\n    });\n\n    call.once('reject', () => {\n      this._log.info(`Rejected: ${call.parameters.CallSid}`);\n      if (this._audio) {\n        this._audio._maybeStopPollingVolume();\n      }\n      this._removeCall(call);\n      this._maybeStopIncomingSound();\n    });\n\n    call.once('transportClose', () => {\n      if (call.status() !== Call.State.Pending) {\n        return;\n      }\n      if (this._audio) {\n        this._audio._maybeStopPollingVolume();\n      }\n      this._removeCall(call);\n      this._maybeStopIncomingSound();\n    });\n\n    return call;\n  }\n\n  /**\n   * Stop the incoming sound if no {@link Call}s remain.\n   */\n  private _maybeStopIncomingSound(): void {\n    if (!this._calls.length) {\n      this._soundcache.get(Device.SoundName.Incoming).stop();\n    }\n  }\n\n  /**\n   * Called when a 'close' event is received from the signaling stream.\n   */\n  private _onSignalingClose = () => {\n    this._stream = null;\n    this._streamConnectedPromise = null;\n  }\n\n  /**\n   * Called when a 'connected' event is received from the signaling stream.\n   */\n  private _onSignalingConnected = (payload: Record<string, any>) => {\n    const region = getRegionShortcode(payload.region);\n    this._edge = regionToEdge[region as Region] || payload.region;\n    this._region = region || payload.region;\n\n    // The signaling stream emits a `connected` event after reconnection, if the\n    // device was registered before this, then register again.\n    if (this._shouldReRegister) {\n      this.register();\n    }\n  }\n\n  /**\n   * Called when an 'error' event is received from the signaling stream.\n   */\n  private _onSignalingError = (payload: Record<string, any>) => {\n    if (typeof payload !== 'object') { return; }\n\n    const { error: originalError, callsid } = payload;\n\n    if (typeof originalError !== 'object') { return; }\n\n    const call: Call | undefined =\n      (typeof callsid === 'string' && this._findCall(callsid)) || undefined;\n\n    const { code, message: customMessage } = originalError;\n    let { twilioError } = originalError;\n\n    if (typeof code === 'number') {\n      if (code === 31201) {\n        twilioError = new AuthorizationErrors.AuthenticationFailed(originalError);\n      } else if (code === 31204) {\n        twilioError = new AuthorizationErrors.AccessTokenInvalid(originalError);\n      } else if (code === 31205) {\n        // Stop trying to register presence after token expires\n        this._stopRegistrationTimer();\n        twilioError = new AuthorizationErrors.AccessTokenExpired(originalError);\n      } else if (hasErrorByCode(code)) {\n        twilioError = new (getErrorByCode(code))(originalError);\n      }\n    }\n\n    if (!twilioError) {\n      this._log.error('Unknown signaling error: ', originalError);\n      twilioError = new GeneralErrors.UnknownError(customMessage, originalError);\n    }\n\n    this._log.info('Received error: ', twilioError);\n    this.emit(Device.EventName.Error, twilioError, call);\n  }\n\n  /**\n   * Called when an 'invite' event is received from the signaling stream.\n   */\n  private _onSignalingInvite = async (payload: Record<string, any>) => {\n    const wasBusy = !!this._activeCall;\n    if (wasBusy && !this._options.allowIncomingWhileBusy) {\n      this._log.info('Device busy; ignoring incoming invite');\n      return;\n    }\n\n    if (!payload.callsid || !payload.sdp) {\n      this.emit(Device.EventName.Error, new ClientErrors.BadRequest('Malformed invite from gateway'));\n      return;\n    }\n\n    const callParameters = payload.parameters || { };\n    callParameters.CallSid = callParameters.CallSid || payload.callsid;\n\n    const customParameters = Object.assign({ }, queryToJson(callParameters.Params));\n    const call = await this._makeCall(customParameters, {\n      callParameters,\n      offerSdp: payload.sdp,\n    });\n\n    this._calls.push(call);\n\n    call.once('accept', () => {\n      this._soundcache.get(Device.SoundName.Incoming).stop();\n      this._publishNetworkChange();\n    });\n\n    const play = (this._enabledSounds.incoming && !wasBusy)\n      ? () => this._soundcache.get(Device.SoundName.Incoming).play()\n      : () => Promise.resolve();\n\n    this._showIncomingCall(call, play);\n  }\n\n  /**\n   * Called when an 'offline' event is received from the signaling stream.\n   */\n  private _onSignalingOffline = () => {\n    this._log.info('Stream is offline');\n\n    this._edge = null;\n    this._region = null;\n\n    this._shouldReRegister = this.state !== Device.State.Unregistered;\n\n    this._setState(Device.State.Unregistered);\n  }\n\n  /**\n   * Called when a 'ready' event is received from the signaling stream.\n   */\n  private _onSignalingReady = () => {\n    this._log.info('Stream is ready');\n\n    this._setState(Device.State.Registered);\n  }\n\n  /**\n   * Publish a NetworkInformation#change event to Insights if there's an active {@link Call}.\n   */\n  private _publishNetworkChange = () => {\n    if (!this._activeCall) {\n      return;\n    }\n\n    if (this._networkInformation) {\n      this._publisher.info('network-information', 'network-change', {\n        connection_type: this._networkInformation.type,\n        downlink: this._networkInformation.downlink,\n        downlinkMax: this._networkInformation.downlinkMax,\n        effective_type: this._networkInformation.effectiveType,\n        rtt: this._networkInformation.rtt,\n      }, this._activeCall);\n    }\n  }\n\n  /**\n   * Remove a {@link Call} from device.calls by reference\n   * @param call\n   */\n  private _removeCall(call: Call): void {\n    if (this._activeCall === call) {\n      this._activeCall = null;\n    }\n\n    for (let i = this._calls.length - 1; i >= 0; i--) {\n      if (call === this._calls[i]) {\n        this._calls.splice(i, 1);\n      }\n    }\n  }\n\n  /**\n   * Register with the signaling server.\n   */\n  private async _sendPresence(presence: boolean): Promise<void> {\n    const stream = await this._streamConnectedPromise;\n\n    if (!stream) { return; }\n\n    stream.register({ audio: presence });\n    if (presence) {\n      this._startRegistrationTimer();\n    } else {\n      this._stopRegistrationTimer();\n    }\n  }\n\n  /**\n   * Helper function that sets and emits the state of the device.\n   * @param state The new state of the device.\n   */\n   private _setState(state: Device.State): void {\n    if (state === this.state) {\n      return;\n    }\n\n    this._state = state;\n    this.emit(this._stateEventMapping[state]);\n  }\n\n  /**\n   * Set up an audio helper for usage by this {@link Device}.\n   */\n  private _setupAudioHelper(): void {\n    if (this._audio) {\n      this._log.info('Found existing audio helper; destroying...');\n      this._destroyAudioHelper();\n    }\n\n    this._audio = new (this._options.AudioHelper || AudioHelper)(\n      this._updateSinkIds,\n      this._updateInputStream,\n      getUserMedia,\n      {\n        audioContext: Device.audioContext,\n        enabledSounds: this._enabledSounds,\n      },\n    );\n\n    this._audio.on('deviceChange', (lostActiveDevices: MediaDeviceInfo[]) => {\n      const activeCall: Call | null = this._activeCall;\n      const deviceIds: string[] = lostActiveDevices.map((device: MediaDeviceInfo) => device.deviceId);\n\n      this._publisher.info('audio', 'device-change', {\n        lost_active_device_ids: deviceIds,\n      }, activeCall);\n\n      if (activeCall) {\n        activeCall['_mediaHandler']._onInputDevicesChanged();\n      }\n    });\n  }\n\n  /**\n   * Create and set a publisher for the {@link Device} to use.\n   */\n  private _setupPublisher(): IPublisher {\n    if (this._publisher) {\n      this._log.info('Found existing publisher; destroying...');\n      this._destroyPublisher();\n    }\n\n    this._publisher = (this._options.Publisher || Publisher)(\n      PUBLISHER_PRODUCT_NAME,\n      this.token,\n      {\n        defaultPayload: this._createDefaultPayload,\n        host: this._options.eventgw,\n        metadata: {\n          app_name: this._options.appName,\n          app_version: this._options.appVersion,\n        },\n      },\n    );\n\n    if (this._options.publishEvents === false) {\n      this._publisher.disable();\n    } else {\n      this._publisher.on('error', (error: Error) => {\n        this._log.warn('Cannot connect to insights.', error);\n      });\n    }\n\n    return this._publisher;\n  }\n\n  /**\n   * Set up the connection to the signaling server. Tears down an existing\n   * stream if called while a stream exists.\n   */\n  private _setupStream(): Promise<IPStream> {\n    if (this._stream) {\n      this._log.info('Found existing stream; destroying...');\n      this._destroyStream();\n    }\n\n    this._log.info('Setting up VSP');\n    this._stream = (this._options.PStream || PStream)(\n      this.token,\n      this._chunderURIs,\n      {\n        backoffMaxMs: this._options.backoffMaxMs,\n      },\n    );\n\n    this._stream.addListener('close', this._onSignalingClose);\n    this._stream.addListener('connected', this._onSignalingConnected);\n    this._stream.addListener('error', this._onSignalingError);\n    this._stream.addListener('invite', this._onSignalingInvite);\n    this._stream.addListener('offline', this._onSignalingOffline);\n    this._stream.addListener('ready', this._onSignalingReady);\n\n    return this._streamConnectedPromise = new Promise<IPStream>(resolve =>\n      this._stream.once('connected', () => {\n        resolve(this._stream);\n      }),\n    );\n  }\n\n  /**\n   * Start playing the incoming ringtone, and subsequently emit the incoming event.\n   * @param call\n   * @param play - The function to be used to play the sound. Must return a Promise.\n   */\n  private _showIncomingCall(call: Call, play: Function): Promise<void> {\n    let timeout: NodeJS.Timer;\n    return Promise.race([\n      play(),\n      new Promise((resolve, reject) => {\n        timeout = setTimeout(() => {\n          const msg = 'Playing incoming ringtone took too long; it might not play. Continuing execution...';\n          reject(new Error(msg));\n        }, RINGTONE_PLAY_TIMEOUT);\n      }),\n    ]).catch(reason => {\n      this._log.info(reason.message);\n    }).then(() => {\n      clearTimeout(timeout);\n      this.emit(Device.EventName.Incoming, call);\n    });\n  }\n\n  /**\n   * Set a timeout to send another register message to the signaling server.\n   */\n  private _startRegistrationTimer(): void {\n    this._stopRegistrationTimer();\n    this._regTimer = setTimeout(() => {\n      this._sendPresence(true);\n    }, REGISTRATION_INTERVAL);\n  }\n\n  /**\n   * Stop sending registration messages to the signaling server.\n   */\n  private _stopRegistrationTimer(): void {\n    if (this._regTimer) {\n      clearTimeout(this._regTimer);\n    }\n  }\n\n  /**\n   * Throw an error if the {@link Device} is destroyed.\n   */\n  private _throwIfDestroyed(): void {\n    if (this.state === Device.State.Destroyed) {\n      throw new InvalidStateError('Device has been destroyed.');\n    }\n  }\n\n  /**\n   * Update the input stream being used for calls so that any current call and all future calls\n   * will use the new input stream.\n   * @param inputStream\n   */\n  private _updateInputStream = (inputStream: MediaStream | null): Promise<void> => {\n    const call: Call | null = this._activeCall;\n\n    if (call && !inputStream) {\n      return Promise.reject(new InvalidStateError('Cannot unset input device while a call is in progress.'));\n    }\n\n    this._callInputStream = inputStream;\n    return call\n      ? call._setInputTracksFromStream(inputStream)\n      : Promise.resolve();\n  }\n\n  /**\n   * Update the device IDs of output devices being used to play the incoming ringtone through.\n   * @param sinkIds - An array of device IDs\n   */\n  private _updateRingtoneSinkIds(sinkIds: string[]): Promise<void> {\n    return Promise.resolve(this._soundcache.get(Device.SoundName.Incoming).setSinkIds(sinkIds));\n  }\n\n  /**\n   * Update the device IDs of output devices being used to play sounds through.\n   * @param type - Whether to update ringtone or speaker sounds\n   * @param sinkIds - An array of device IDs\n   */\n  private _updateSinkIds = (type: 'ringtone' | 'speaker', sinkIds: string[]): Promise<void> => {\n    const promise: Promise<void> = type === 'ringtone'\n      ? this._updateRingtoneSinkIds(sinkIds)\n      : this._updateSpeakerSinkIds(sinkIds);\n\n    return promise.then(() => {\n      this._publisher.info('audio', `${type}-devices-set`, {\n        audio_device_ids: sinkIds,\n      }, this._activeCall);\n    }, error => {\n      this._publisher.error('audio', `${type}-devices-set-failed`, {\n        audio_device_ids: sinkIds,\n        message: error.message,\n      }, this._activeCall);\n\n      throw error;\n    });\n  }\n\n  /**\n   * Update the device IDs of output devices being used to play the non-ringtone sounds\n   * and Call audio through.\n   * @param sinkIds - An array of device IDs\n   */\n  private _updateSpeakerSinkIds(sinkIds: string[]): Promise<void> {\n    Array.from(this._soundcache.entries())\n      .filter(entry => entry[0] !== Device.SoundName.Incoming)\n      .forEach(entry => entry[1].setSinkIds(sinkIds));\n\n    this._callSinkIds = sinkIds;\n    const call = this._activeCall;\n    return call\n      ? call._setSinkIds(sinkIds)\n      : Promise.resolve();\n  }\n}\n\nnamespace Device {\n  /**\n   * Emitted when the {@link Device} receives an error.\n   * @param error\n   * @example `device.on('error', call => { })`\n   * @event\n   */\n  declare function errorEvent(error: TwilioError, call?: Call): void;\n\n  /**\n   * Emitted when an incoming {@link Call} is received.\n   * @param call - The incoming {@link Call}.\n   * @example `device.on('incoming', call => { })`\n   * @event\n   */\n  declare function incomingEvent(call: Call): void;\n\n  /**\n   * Emitted when the {@link Device} is unregistered.\n   * @param device\n   * @example `device.on('unregistered', device => { })`\n   * @event\n   */\n  declare function unregisteredEvent(device: Device): void;\n\n  /**\n   * Emitted when the {@link Device} is registering.\n   * @param device\n   * @example `device.on('registering', device => { })`\n   * @event\n   */\n  declare function registeringEvent(device: Device): void;\n\n  /**\n   * Emitted when the {@link Device} is registered.\n   * @param device\n   * @example `device.on('registered', device => { })`\n   * @event\n   */\n  declare function registeredEvent(device: Device): void;\n\n  /**\n   * All valid {@link Device} event names.\n   */\n  export enum EventName {\n    Error = 'error',\n    Incoming = 'incoming',\n    Destroyed = 'destroyed',\n    Unregistered = 'unregistered',\n    Registering = 'registering',\n    Registered = 'registered',\n  }\n\n  /**\n   * All possible {@link Device} states.\n   */\n  export enum State {\n    Destroyed = 'destroyed',\n    Unregistered = 'unregistered',\n    Registering = 'registering',\n    Registered = 'registered',\n  }\n\n  /**\n   * Names of all sounds handled by the {@link Device}.\n   */\n  export enum SoundName {\n    Incoming = 'incoming',\n    Outgoing = 'outgoing',\n    Disconnect = 'disconnect',\n    Dtmf0 = 'dtmf0',\n    Dtmf1 = 'dtmf1',\n    Dtmf2 = 'dtmf2',\n    Dtmf3 = 'dtmf3',\n    Dtmf4 = 'dtmf4',\n    Dtmf5 = 'dtmf5',\n    Dtmf6 = 'dtmf6',\n    Dtmf7 = 'dtmf7',\n    Dtmf8 = 'dtmf8',\n    Dtmf9 = 'dtmf9',\n    DtmfS = 'dtmfs',\n    DtmfH = 'dtmfh',\n  }\n\n  /**\n   * Names of all togglable sounds.\n   */\n  export type ToggleableSound = Device.SoundName.Incoming | Device.SoundName.Outgoing | Device.SoundName.Disconnect;\n\n  /**\n   * Options to be passed to {@link Device.connect}.\n   */\n  export interface ConnectOptions extends Call.AcceptOptions {\n   /**\n    * A flat object containing key:value pairs to be sent to the TwiML app.\n    */\n    params?: Record<string, string>;\n  }\n\n  /**\n   * Options that may be passed to the {@link Device} constructor, or Device.setup via public API\n   */\n  export interface Options {\n    /**\n     * Whether the Device should raise the {@link incomingEvent} event when a new call invite is\n     * received while already on an active call. Default behavior is false.\n     */\n    allowIncomingWhileBusy?: boolean;\n\n    /**\n     * A name for the application that is instantiating the {@link Device}. This is used to improve logging\n     * in Insights by associating Insights data with a specific application, particularly in the case where\n     * one account may be connected to by multiple applications.\n     */\n    appName?: string;\n\n    /**\n     * A version for the application that is instantiating the {@link Device}. This is used to improve logging\n     * in Insights by associating Insights data with a specific version of the given application. This can help\n     * track down when application-level bugs were introduced.\n     */\n    appVersion?: string;\n\n    /**\n     * Whether to enable close protection, to prevent users from accidentally\n     * navigating away from the page during a call. If string, the value will\n     * be used as a custom message.\n     */\n    closeProtection?: boolean | string;\n\n    /**\n     * An ordered array of codec names, from most to least preferred.\n     */\n    codecPreferences?: Call.Codec[];\n\n    /**\n     * Whether AudioContext sounds should be disabled. Useful for trouble shooting sound issues\n     * that may be caused by AudioContext-specific sounds. If set to true, will fall back to\n     * HTMLAudioElement sounds.\n     */\n    disableAudioContextSounds?: boolean;\n\n    /**\n     * Whether to use googDscp in RTC constraints.\n     */\n    dscp?: boolean;\n\n    /**\n     * The edge value corresponds to the geographic location that the client\n     * will use to connect to Twilio infrastructure. The default value is\n     * \"roaming\" which automatically selects an edge based on the latency of the\n     * client relative to available edges.\n     */\n    edge?: string[] | string;\n\n    /**\n     * Experimental feature.\n     * Whether to use ICE Aggressive nomination.\n     */\n    forceAggressiveIceNomination?: boolean;\n\n    /**\n     * Log level.\n     */\n    logLevel?: LogLevelDesc;\n\n    /**\n     * The maximum average audio bitrate to use, in bits per second (bps) based on\n     * [RFC-7587 7.1](https://tools.ietf.org/html/rfc7587#section-7.1). By default, the setting\n     * is not used. If you specify 0, then the setting is not used. Any positive integer is allowed,\n     * but values outside the range 6000 to 510000 are ignored and treated as 0. The recommended\n     * bitrate for speech is between 8000 and 40000 bps as noted in\n     * [RFC-7587 3.1.1](https://tools.ietf.org/html/rfc7587#section-3.1.1).\n     */\n    maxAverageBitrate?: number;\n\n    /**\n     * A mapping of custom sound URLs by sound name.\n     */\n    sounds?: Partial<Record<Device.SoundName, string>>;\n  }\n}\n\nexport default Device;\n"]}